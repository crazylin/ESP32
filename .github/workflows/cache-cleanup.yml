name: Cache Cleanup

on:
  schedule:
    # æ¯å‘¨æ—¥å‡Œæ™¨ 2 ç‚¹è¿è¡Œ
    - cron: '0 2 * * 0'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (show what would be deleted)'
        required: false
        default: true
        type: boolean

jobs:
  cleanup:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Cache Cleanup
      uses: actions/github-script@v6
      with:
        script: |
          const owner = context.repo.owner;
          const repo = context.repo.repo;
          
          console.log(`ğŸ” å¼€å§‹æ¸…ç† ${owner}/${repo} çš„ç¼“å­˜...`);
          
          // è·å–æ‰€æœ‰ç¼“å­˜
          const caches = await github.rest.actions.getActionsCacheList({
            owner,
            repo,
            per_page: 100
          });
          
          console.log(`ğŸ“Š æ‰¾åˆ° ${caches.data.actions_caches.length} ä¸ªç¼“å­˜`);
          
          let deletedCount = 0;
          let totalSize = 0;
          
          for (const cache of caches.data.actions_caches) {
            const cacheAge = Date.now() - new Date(cache.created_at).getTime();
            const cacheAgeDays = Math.floor(cacheAge / (1000 * 60 * 60 * 24));
            
            console.log(`ğŸ“¦ ç¼“å­˜: ${cache.key}`);
            console.log(`   å¤§å°: ${(cache.size_in_bytes / 1024 / 1024).toFixed(2)} MB`);
            console.log(`   åˆ›å»ºæ—¶é—´: ${cache.created_at}`);
            console.log(`   å¹´é¾„: ${cacheAgeDays} å¤©`);
            
            // åˆ é™¤è¶…è¿‡ 7 å¤©çš„ç¼“å­˜
            if (cacheAgeDays > 7) {
              if (!core.getInput('dry_run') || core.getInput('dry_run') === 'true') {
                console.log(`   ğŸ—‘ï¸  å°†åˆ é™¤: ${cache.key}`);
              } else {
                await github.rest.actions.deleteActionsCacheByKey({
                  owner,
                  repo,
                  key: cache.key
                });
                console.log(`   âœ… å·²åˆ é™¤: ${cache.key}`);
              }
              
              deletedCount++;
              totalSize += cache.size_in_bytes;
            }
          }
          
          console.log(`\nğŸ§¹ æ¸…ç†å®Œæˆ`);
          console.log(`   åˆ é™¤æ•°é‡: ${deletedCount}`);
          console.log(`   é‡Šæ”¾ç©ºé—´: ${(totalSize / 1024 / 1024).toFixed(2)} MB`);
          
          if (core.getInput('dry_run') === 'true') {
            console.log(`\nâš ï¸  è¿™æ˜¯å¹²è¿è¡Œï¼Œå®é™…æœªåˆ é™¤ä»»ä½•ç¼“å­˜`);
            console.log(`   è®¾ç½® dry_run=false æ¥å®é™…æ‰§è¡Œæ¸…ç†`);
          }

  cleanup-logs:
    runs-on: ubuntu-latest
    needs: cleanup
    
    steps:
    - name: Cleanup old workflow logs
      uses: actions/github-script@v6
      with:
        script: |
          const owner = context.repo.owner;
          const repo = context.repo.repo;
          
          // è·å–å·¥ä½œæµè¿è¡Œè®°å½•
          const runs = await github.rest.actions.listWorkflowRunsForRepo({
            owner,
            repo,
            per_page: 100
          });
          
          console.log(`ğŸ“‹ æ‰¾åˆ° ${runs.data.workflow_runs.length} ä¸ªå·¥ä½œæµè¿è¡Œè®°å½•`);
          
          let deletedLogs = 0;
          
          for (const run of runs.data.workflow_runs) {
            const runAge = Date.now() - new Date(run.created_at).getTime();
            const runAgeDays = Math.floor(runAge / (1000 * 60 * 60 * 24));
            
            // åˆ é™¤è¶…è¿‡ 30 å¤©çš„æ—¥å¿—
            if (runAgeDays > 30) {
              try {
                await github.rest.actions.deleteWorkflowRunLogs({
                  owner,
                  repo,
                  run_id: run.id
                });
                console.log(`ğŸ—‘ï¸  å·²åˆ é™¤å·¥ä½œæµ #${run.id} çš„æ—¥å¿—`);
                deletedLogs++;
              } catch (error) {
                console.log(`âš ï¸  æ— æ³•åˆ é™¤å·¥ä½œæµ #${run.id} çš„æ—¥å¿—: ${error.message}`);
              }
            }
          }
          
          console.log(`\nğŸ§¹ æ—¥å¿—æ¸…ç†å®Œæˆ`);
          console.log(`   åˆ é™¤æ—¥å¿—æ•°é‡: ${deletedLogs}`);